{% extends 'core/base.html' %}

{% block content %}
<div class="container py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-0"><i class="bi bi-key-fill me-2 text-warning"></i>Gabarito Oficial</h3>
            <p class="text-muted small mb-0">{{ avaliacao.titulo }} - {{ avaliacao.turma.nome }}</p>
        </div>
        <a href="{% url 'gerenciar_avaliacoes' %}" class="btn btn-light border rounded-pill fw-bold">Voltar</a>
    </div>

    {% if not tem_itens %}
    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-body p-4 text-center">
            <h5 class="fw-bold text-muted mb-3">Quantas questões tem a prova?</h5>
            <form method="post" class="d-flex justify-content-center gap-2">
                {% csrf_token %}
                <input type="number" name="qtd_questoes" class="form-control form-control-lg text-center fw-bold" style="width: 100px;" value="10" min="1" max="100">
                <button type="submit" class="btn btn-primary px-4 fw-bold">Gerar Grade</button>
            </form>
        </div>
    </div>
    {% else %}

    <form method="post" class="card border-0 shadow-lg rounded-4 overflow-hidden">
        {% csrf_token %}
        <div class="card-header bg-white border-bottom p-3 d-flex justify-content-between align-items-center">
            <span class="fw-bold text-primary">Mapeamento de Questões</span>
            <span class="badge bg-light text-dark border">{{ itens.count }} Questões</span>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 600px;">
                <table class="table table-hover align-middle mb-0 text-center">
                    <thead class="bg-light sticky-top">
                        <tr>
                            <th class="py-3">#</th>
                            <th>Questão / Descritor</th>
                            <th class="text-center" style="width: 150px;">Gabarito</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in itens %}
                        <tr>
                            <td class="fw-bold text-muted" style="width: 60px;">{{ item.numero }}</td>
                            
                            <td class="text-start">
                                {% if item.questao_banco %}
                                    <span class="d-block text-truncate" style="max-width: 500px;" title="{{ item.questao_banco.enunciado }}">
                                        {{ item.questao_banco.enunciado }}
                                    </span>
                                    <small class="text-primary fst-italic">
                                        {{ item.descritor.codigo }} - {{ item.descritor.descricao }}
                                    </small>
                                {% else %}
                                    <select name="descritor_{{ item.id }}" class="form-select border-0 text-start">
                                        <option value="">-- Sem descritor --</option>
                                        {% for d in descritores %}
                                        <option value="{{ d.id }}" {% if item.descritor_id == d.id %}selected{% endif %}>
                                            {{ d.codigo }} - {{ d.descricao|truncatechars:60 }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                            </td>

                            <td style="width: 150px;">
                                <select name="resposta_{{ item.id }}" class="form-select text-center fw-bold bg-light border-0">
                                    {% for op in "ABCDE"|make_list %}
                                    <option value="{{ op }}" {% if item.resposta_correta == op %}selected{% endif %}>{{ op }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer bg-white p-4 border-top shadow-sm" style="z-index: 10;">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                
                <div class="form-check form-switch p-3 bg-warning bg-opacity-10 rounded-3 border border-warning w-100 w-md-auto">
                    <input class="form-check-input" type="checkbox" id="checkReplicar" name="replicar_para_todos">
                    <label class="form-check-label fw-bold text-dark" for="checkReplicar">
                        Aplicar este gabarito para TODAS as turmas?
                    </label>
                    <div class="small text-muted mt-1" style="line-height: 1.2;">
                        Isso copiará as respostas e descritores para todas as outras avaliações chamadas <strong>"{{ avaliacao.titulo }}"</strong>.
                    </div>
                </div>

                <button type="submit" class="btn btn-success btn-lg px-5 fw-bold shadow">
                    <i class="bi bi-check-lg me-2"></i> Salvar Gabarito
                </button>
            </div>
        </div>
    </form>
    {% endif %}
</div>
{% endblock %}