{% extends 'core/base.html' %}

{% block content %}
<div class="container-fluid py-4">
    
    <div class="card shadow-sm border-0 mb-4 rounded-4">
        <div class="card-body p-4 d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div class="flex-grow-1">
                <h6 class="text-uppercase text-muted fw-bold mb-2 small">
                    <i class="bi bi-collection-fill me-1"></i> Selecione a Avaliação
                </h6>
                <form method="get">
                    <select name="avaliacao_id" class="form-select form-select-lg border-0 bg-light fw-bold text-dark shadow-none cursor-pointer" onchange="this.form.submit()">
                        <option value="">--- Clique para escolher ---</option>
                        {% for av in avaliacoes_todas %}
                            <option value="{{ av.id }}" {% if avaliacao_selecionada and av.id == avaliacao_selecionada.id %}selected{% endif %}>
                                {{ av.turma.nome }} - {{ av.titulo }} ({{ av.data_aplicacao|date:"d/m" }})
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </div>

            {% if avaliacao_selecionada %}
            <div class="d-flex align-items-center gap-3">
                <div class="text-end border-end pe-3 d-none d-md-block">
                    <div class="small text-muted fw-bold">DISCIPLINA</div>
                    <div class="fw-bold text-primary">{{ avaliacao_selecionada.disciplina.nome }}</div>
                </div>
                <div class="text-center bg-primary bg-opacity-10 p-2 rounded-3 px-4">
                    <div class="h4 fw-bold text-primary mb-0">{{ itens.count }}</div>
                    <div class="small fw-bold text-primary opacity-75" style="font-size: 0.65rem;">QUESTÕES</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if avaliacao_selecionada %}
    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100 rounded-4">
                <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                    <h5 class="fw-bold text-dark mb-3">Alunos</h5>
                    <input type="text" id="buscaAluno" class="form-control bg-light border-0" placeholder="Buscar aluno..." autocomplete="off">
                </div>
                <div class="card-body p-0 mt-3">
                    <div class="list-group list-group-flush overflow-auto custom-scrollbar" style="max-height: 600px;" id="listaAlunos">
                        {% for mat in matriculas %}
                            <a href="#" class="list-group-item list-group-item-action py-3 px-4 border-0 d-flex align-items-center justify-content-between aluno-item transition-hover" 
                               data-id="{{ mat.aluno.id }}" 
                               id="aluno-row-{{ mat.aluno.id }}"
                               onclick="selecionarAluno(this, '{{ mat.aluno.id }}', '{{ mat.aluno.nome_completo }}'); return false;">
                                
                                <div class="d-flex align-items-center gap-3">
                                    <div class="avatar-circle bg-light text-muted fw-bold d-flex align-items-center justify-content-center" 
                                         style="width: 35px; height: 35px; border-radius: 50%;">
                                        {{ mat.aluno.nome_completo|slice:":1" }}
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark nome-aluno lh-1">{{ mat.aluno.nome_completo }}</div>
                                        <small class="text-muted" style="font-size: 0.75rem;">Matr: {{ mat.id }}</small>
                                    </div>
                                </div>

                                <i class="bi bi-circle text-muted status-icon" style="font-size: 0.8rem;"></i>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-4 h-100" id="cardLancamento" style="opacity: 0.5; pointer-events: none;">
                
                <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center px-4">
                    <div>
                        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">ALUNO SELECIONADO</small>
                        <h5 class="mb-0 fw-bold text-primary" id="nomeAlunoDisplay">---</h5>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <label class="btn btn-outline-primary fw-bold rounded-pill px-3 cursor-pointer shadow-sm">
                            <i class="bi bi-camera-fill me-2"></i> Scanner
                            <input type="file" accept="image/*" capture="environment" id="inputFoto" class="d-none" onchange="processarFoto(this)">
                        </label>

                        <div class="form-check form-switch bg-danger bg-opacity-10 p-2 ps-5 rounded-pill border border-danger border-opacity-25">
                            <input class="form-check-input cursor-pointer" type="checkbox" id="checkAusente" onchange="toggleAusencia()">
                            <label class="form-check-label fw-bold text-danger cursor-pointer" for="checkAusente">Ausente</label>
                        </div>
                    </div>
                </div>

                <div class="card-body p-4 bg-light position-relative">
                    
                    <div id="loader" class="position-absolute top-50 start-50 translate-middle d-none text-center" style="z-index: 20;">
                        <div class="spinner-border text-primary mb-2" role="status" style="width: 3rem; height: 3rem;"></div>
                        <div class="fw-bold text-dark bg-white px-3 py-1 rounded shadow-sm" id="msgLoader">Carregando...</div>
                    </div>

                    <div class="d-flex flex-wrap gap-2 justify-content-start" id="gradeQuestoes">
                        {% for item in itens %}
                        <div class="card border-0 shadow-sm text-center overflow-hidden input-wrapper" style="width: 70px;">
                            <div class="card-header bg-white py-1 px-0 border-bottom-0">
                                <small class="fw-bold text-muted" style="font-size: 0.7rem;">{{ item.numero }}</small>
                            </div>
                            <div class="card-body p-1">
                                <input type="text" 
                                       data-numero="{{ item.numero }}"
                                       data-gabarito="{{ item.resposta_correta }}" 
                                       data-index="{{ forloop.counter0 }}" 
                                       class="form-control form-control-lg text-center fw-bold border-0 bg-light input-resposta p-0" 
                                       style="height: 40px; font-size: 1.2rem; border-radius: 8px;"
                                       maxlength="1" 
                                       autocomplete="off"
                                       oninput="validarInput(this)">
                            </div>
                            <div class="card-footer bg-white py-1 px-0 border-top-0">
                                <small class="text-success fw-bold opacity-50" style="font-size: 0.6rem;">{{ item.resposta_correta }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="d-grid mt-5">
                        <button type="button" class="btn btn-success btn-lg fw-bold shadow-lg py-3 rounded-pill transition-hover" onclick="salvarNotas()">
                            <i class="bi bi-check-circle-fill me-2"></i> SALVAR NOTA
                        </button>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    const AVALIACAO_ID = "{{ avaliacao_selecionada.id|default:'' }}";
    let ALUNO_ATUAL_ID = null;

    // --- 1. SELEÇÃO DE ALUNO ---
    function selecionarAluno(elemento, id, nome) {
        // Visual
        document.querySelectorAll('.aluno-item').forEach(el => el.classList.remove('active', 'bg-primary-subtle'));
        elemento.classList.add('active', 'bg-primary-subtle'); 
        
        // Setup
        ALUNO_ATUAL_ID = id;
        document.getElementById('nomeAlunoDisplay').innerText = nome;
        document.getElementById('cardLancamento').style.opacity = '1';
        document.getElementById('cardLancamento').style.pointerEvents = 'auto';
        
        limparCampos();
        mostrarLoader(true, "Carregando dados...");

        // Fetch Dados
        fetch(`/api/lancar-notas-ajax/?aluno_id=${id}&avaliacao_id=${AVALIACAO_ID}`)
            .then(res => res.json())
            .then(data => {
                mostrarLoader(false);
                if(data.sucesso && data.dados) {
                    preencherCampos(data.dados);
                }
            })
            .catch(err => {
                mostrarLoader(false);
                alert("Erro de conexão ao carregar aluno.");
            });
    }

    // --- 2. PREENCHIMENTO DE CAMPOS ---
    function preencherCampos(dados) {
        document.getElementById('checkAusente').checked = dados.ausente;
        toggleAusencia();

        if (!dados.ausente && dados.respostas) {
            for (const [num, letra] of Object.entries(dados.respostas)) {
                const input = document.querySelector(`.input-resposta[data-numero="${num}"]`);
                if(input) {
                    input.value = (letra === 'X') ? '' : letra; 
                    validarInput(input); // Aplica a cor Verde/Vermelho
                }
            }
        }
    }

    // --- 3. LÓGICA VISUAL (VERDE/VERMELHO) ---
    function validarInput(input) {
        input.value = input.value.toUpperCase();
        const letra = input.value;
        const gabarito = input.dataset.gabarito;

        // Remove classes antigas
        input.classList.remove('bg-success', 'text-white', 'bg-danger', 'bg-light');

        if (!letra) {
            input.classList.add('bg-light'); // Vazio = Cinza
            return;
        }

        if (letra === gabarito) {
            input.classList.add('bg-success', 'text-white'); // Acertou = Verde
        } else {
            input.classList.add('bg-danger', 'text-white'); // Errou = Vermelho
        }

        // Pulo automático para o próximo
        if (letra.length === 1) {
            const nextIdx = parseInt(input.dataset.index) + 1;
            const nextInput = document.querySelectorAll('.input-resposta')[nextIdx];
            if (nextInput) nextInput.focus();
        }
    }

    // --- 4. SALVAR (AJAX) ---
    function salvarNotas() {
        if (!ALUNO_ATUAL_ID) return;

        const btn = document.querySelector('.btn-success');
        const txtOriginal = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';
        btn.disabled = true;

        const inputs = document.querySelectorAll('.input-resposta');
        const respostas = {};
        inputs.forEach(inp => {
            if(inp.value.trim()) respostas[inp.dataset.numero] = inp.value.trim().toUpperCase();
        });

        const payload = {
            aluno_id: ALUNO_ATUAL_ID,
            avaliacao_id: AVALIACAO_ID,
            respostas: respostas,
            ausente: document.getElementById('checkAusente').checked
        };

        fetch('/api/lancar-notas-ajax/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            btn.innerHTML = txtOriginal;
            btn.disabled = false;

            if (data.sucesso) {
                mostrarToast("Salvo!", data.msg, "success");
                
                // Marca Check na lista
                const icone = document.querySelector(`#aluno-row-${ALUNO_ATUAL_ID} .status-icon`);
                if(icone) {
                    icone.className = 'bi bi-check-circle-fill text-success fs-5 status-icon';
                }
            } else {
                mostrarToast("Erro", data.erro, "danger");
            }
        })
        .catch(err => {
            btn.innerHTML = txtOriginal;
            btn.disabled = false;
            mostrarToast("Erro", "Falha de conexão.", "danger");
        });
    }

    // --- 5. PROCESSAMENTO DE FOTO (SCANNER) ---
    function processarFoto(input) {
        if (input.files && input.files[0]) {
            if(!ALUNO_ATUAL_ID) {
                alert("Selecione um aluno na lista antes de escanear.");
                input.value = ''; // Limpa
                return;
            }

            const formData = new FormData();
            formData.append('foto', input.files[0]);
            formData.append('avaliacao_id', AVALIACAO_ID);

            mostrarLoader(true, "Lendo Gabarito com IA...");

            fetch('/api/ler-cartao/', { // SUA ROTA DE SCANNER
                method: 'POST',
                body: formData,
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            })
            .then(response => response.json())
            .then(data => {
                mostrarLoader(false);
                if (data.sucesso && data.respostas) {
                    // Preenche os inputs com o que a IA leu
                    for (const [num, letra] of Object.entries(data.respostas)) {
                        const campo = document.querySelector(`.input-resposta[data-numero="${num}"]`);
                        if (campo) {
                            campo.value = letra;
                            validarInput(campo); // Aplica as cores
                        }
                    }
                    mostrarToast("Sucesso", "Leitura concluída! Verifique e salve.", "success");
                } else {
                    mostrarToast("Erro na Leitura", data.erro || "Não foi possível ler o cartão.", "danger");
                }
            })
            .catch(error => {
                mostrarLoader(false);
                mostrarToast("Erro", "Falha ao enviar imagem.", "danger");
                console.error(error);
            });
            
            input.value = ''; // Limpa para permitir nova foto
        }
    }

    // --- FUNÇÕES DE INTERFACE ---

    function limparCampos() {
        document.querySelectorAll('.input-resposta').forEach(i => {
            i.value = '';
            i.className = 'form-control form-control-lg text-center fw-bold border-0 bg-light input-resposta p-0'; // Reseta classes
        });
        document.getElementById('checkAusente').checked = false;
        toggleAusencia();
    }

    function toggleAusencia() {
        const isAusente = document.getElementById('checkAusente').checked;
        document.querySelectorAll('.input-resposta').forEach(inp => {
            inp.disabled = isAusente;
            if(isAusente) {
                inp.value = '';
                inp.classList.remove('bg-success', 'bg-danger', 'text-white');
                inp.classList.add('bg-light');
            }
        });
    }

    function mostrarLoader(show, msg="Carregando...") {
        const loader = document.getElementById('loader');
        const grade = document.getElementById('gradeQuestoes');
        const txt = document.getElementById('msgLoader');
        
        if(show) { 
            txt.innerText = msg;
            loader.classList.remove('d-none'); 
            grade.style.opacity = '0.3'; 
        } else { 
            loader.classList.add('d-none'); 
            grade.style.opacity = '1'; 
        }
    }

    function mostrarToast(titulo, msg, tipo) {
        let container = document.getElementById('toast-container');
        if(!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }
        const html = `
            <div class="toast show align-items-center text-bg-${tipo} border-0 shadow mb-2" role="alert">
                <div class="d-flex">
                    <div class="toast-body fw-bold">
                        <i class="bi bi-${tipo === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i> ${msg}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>`;
        const el = document.createElement('div');
        el.innerHTML = html;
        container.appendChild(el.firstElementChild);
        setTimeout(() => { if(container.firstChild) container.firstChild.remove(); }, 3000);
    }

    // --- COLAR INTELIGENTE (EXCEL) ---
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.input-resposta');
        
        inputs.forEach(input => {
            input.addEventListener('paste', function(e) {
                if(this.disabled) return;
                e.preventDefault();
                let text = (e.clipboardData || window.clipboardData).getData('text');
                text = text.replace(/[\s\n\r]/g, '').toUpperCase(); 
                if(!text) return;

                let startIdx = parseInt(this.dataset.index);
                for(let i=0; i < text.length; i++) {
                    let targetIdx = startIdx + i;
                    if(targetIdx < inputs.length) {
                        inputs[targetIdx].value = text[i];
                        validarInput(inputs[targetIdx]); // Aplica cor
                    }
                }
                document.querySelector('.btn-success').focus();
            });

            input.addEventListener('focus', function() { this.select(); });
        });

        // Filtro de Busca
        document.getElementById('buscaAluno').addEventListener('keyup', function() {
            const termo = this.value.toLowerCase();
            document.querySelectorAll('.aluno-item').forEach(item => {
                const nome = item.querySelector('.nome-aluno').innerText.toLowerCase();
                item.style.display = nome.includes(termo) ? 'flex' : 'none';
                if(!nome.includes(termo)) item.classList.remove('d-flex');
            });
        });
    });
</script>

<style>
    .cursor-pointer { cursor: pointer; }
    .input-resposta:focus { 
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.25); 
        z-index: 10; 
        transform: scale(1.1);
    }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #dee2e6; border-radius: 4px; }
    .transition-hover:hover { transform: translateY(-3px); }
    .aluno-item.active { border-left: 5px solid var(--accent-color, #0d6efd) !important; background-color: #e9ecef; }
    
    /* Cores Fortes para Inputs */
    .bg-success { background-color: #198754 !important; }
    .bg-danger { background-color: #dc3545 !important; }
    .text-white { color: white !important; }
</style>
{% endblock %}