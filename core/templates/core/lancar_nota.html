{% extends 'core/base.html' %}

{% block content %}
<div class="container-fluid py-4">
    
    <div class="card shadow-sm border-0 mb-4 rounded-4">
        <div class="card-body p-4 d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div class="flex-grow-1">
                <h6 class="text-uppercase text-muted fw-bold mb-2" style="font-size: 0.75rem; letter-spacing: 1px;">
                    <i class="bi bi-collection-fill me-1"></i> Selecione a Avaliação
                </h6>
                <form method="get">
                    <select name="avaliacao_id" class="form-select form-select-lg border-0 bg-light fw-bold text-dark shadow-none" onchange="this.form.submit()" style="cursor: pointer;">
                        <option value="">--- Clique para escolher ---</option>
                        {% for av in avaliacoes_todas %}
                            <option value="{{ av.id }}" {% if avaliacao_selecionada and av.id == avaliacao_selecionada.id %}selected{% endif %}>
                                {{ av.titulo }} - {{ av.turma.nome }} ({{ av.data_aplicacao|date:"d/m" }})
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </div>

            {% if avaliacao_selecionada %}
            <div class="d-flex align-items-center gap-3">
                <div class="text-end border-end pe-3 d-none d-md-block">
                    <div class="small text-muted fw-bold">DISCIPLINA</div>
                    <div class="fw-bold text-primary">{{ avaliacao_selecionada.disciplina.nome }}</div>
                </div>
                <div class="text-center bg-primary bg-opacity-10 p-2 rounded-3">
                    <div class="h4 fw-bold text-primary mb-0">{{ itens.count }}</div>
                    <div class="small fw-bold text-primary opacity-75" style="font-size: 0.65rem;">QUESTÕES</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if avaliacao_selecionada %}
    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100 rounded-4">
                <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                    <h5 class="fw-bold text-dark"><i class="bi bi-people-fill me-2 text-primary"></i>Alunos</h5>
                    <div class="input-group mt-3">
                        <span class="input-group-text bg-light border-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" id="buscaAluno" class="form-control bg-light border-0" placeholder="Filtrar por nome..." autocomplete="off">
                    </div>
                </div>
                <div class="card-body p-4">
                    <form method="post" id="formLancamento">
                        {% csrf_token %}
                        <div class="list-group shadow-sm overflow-auto custom-scrollbar" style="max-height: 400px;" id="listaAlunos">
                            {% for aluno in alunos %}
                                <label class="list-group-item list-group-item-action d-flex align-items-center gap-3 border-0 py-3 rounded-3 mb-1 cursor-pointer">
                                    <input class="form-check-input flex-shrink-0" type="radio" name="aluno" value="{{ aluno.id }}" required>
                                    <span class="fw-bold text-dark nome-aluno">{{ aluno.nome_completo }}</span>
                                </label>
                            {% empty %}
                                <div class="text-center py-5 text-muted">
                                    <i class="bi bi-emoji-frown display-4 opacity-25"></i>
                                    <p class="mt-2 small fw-bold">Nenhum aluno ativo nesta turma.</p>
                                </div>
                            {% endfor %}
                        </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-4 h-100">
                <div class="card-header bg-primary text-white py-3 border-0 d-flex justify-content-between align-items-center px-4">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-grid-3x3-gap-fill me-2"></i>Cartão Resposta</h5>
                    <span class="badge bg-white text-primary fw-bold">Modo Rápido</span>
                </div>
                <div class="card-body p-4 bg-light">
                    
                    <div class="d-flex flex-wrap gap-2 justify-content-start" id="gradeQuestoes">
                        {% for item in itens %}
                        <div class="card border-0 shadow-sm text-center overflow-hidden" style="width: 75px;">
                            <div class="card-header bg-white py-1 px-0 border-bottom-0">
                                <small class="fw-bold text-muted" style="font-size: 0.7rem;">Q.{{ item.numero }}</small>
                            </div>
                            <div class="card-body p-1">
                                <input type="text" 
                                       name="resposta_{{ item.id }}" 
                                       class="form-control form-control-lg text-center fw-bold border-0 bg-light input-resposta p-0" 
                                       style="height: 40px; font-size: 1.2rem; border-radius: 8px;"
                                       maxlength="1" 
                                       autocomplete="off">
                            </div>
                            <div class="card-footer bg-white py-1 px-0 border-top-0">
                                <small class="text-success fw-bold opacity-50" style="font-size: 0.6rem;">{{ item.resposta_correta }}</small>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center w-100 py-5">
                            <i class="bi bi-cone-striped text-warning display-1"></i>
                            <h4 class="mt-3 fw-bold">Gabarito não definido!</h4>
                            <p class="text-muted">Você precisa configurar o gabarito desta prova antes de lançar notas.</p>
                            <a href="{% url 'definir_gabarito' avaliacao_selecionada.id %}" class="btn btn-warning fw-bold px-4 mt-2">Configurar Agora</a>
                        </div>
                        {% endfor %}
                    </div>

                    {% if itens %}
                    <div class="d-grid mt-5">
                        <button type="submit" class="btn btn-success btn-lg fw-bold shadow-lg py-3 rounded-pill transition-hover">
                            <i class="bi bi-check-circle-fill me-2"></i> SALVAR LANÇAMENTO
                        </button>
                    </div>
                    {% endif %}
                    
                    </form> </div>
            </div>
        </div>

    </div>
    {% else %}
    <div class="text-center py-5 mt-5">
        <div class="mb-3 p-4 rounded-circle bg-light d-inline-block shadow-sm">
            <i class="bi bi-arrow-up text-primary display-4"></i>
        </div>
        <h3 class="fw-bold text-dark">Comece selecionando uma avaliação</h3>
        <p class="text-muted">Escolha a prova no menu acima para liberar o painel de lançamento.</p>
    </div>
    {% endif %}

</div>

<style>
    .cursor-pointer { cursor: pointer; }
    
    /* Efeito de Foco no Input */
    .input-resposta:focus {
        background-color: #fff3cd !important; /* Amarelo */
        color: #000;
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        z-index: 10;
    }

    /* Scrollbar personalizada na lista */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #dee2e6; border-radius: 4px; }
    
    /* Hover no Botão */
    .transition-hover:hover { transform: translateY(-3px); }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // 1. FILTRO DE ALUNOS (Em tempo real)
    const buscaInput = document.getElementById('buscaAluno');
    const listaAlunos = document.getElementById('listaAlunos');
    
    if (buscaInput && listaAlunos) {
        buscaInput.addEventListener('keyup', function() {
            const termo = this.value.toLowerCase();
            const itens = listaAlunos.querySelectorAll('.list-group-item');
            
            itens.forEach(item => {
                const nome = item.querySelector('.nome-aluno').innerText.toLowerCase();
                if (nome.includes(termo)) {
                    item.classList.remove('d-none');
                    item.classList.add('d-flex');
                } else {
                    item.classList.add('d-none');
                    item.classList.remove('d-flex');
                }
            });
        });
    }

    // 2. PULO AUTOMÁTICO DE INPUTS
    const inputs = document.querySelectorAll('.input-resposta');
    inputs.forEach((input, index) => {
        input.addEventListener('input', function() {
            this.value = this.value.toUpperCase(); // Força maiúscula
            
            // Se digitou uma letra válida (A-E), pula
            if (this.value.length === 1 && /[A-E]/.test(this.value)) {
                if (index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            }
        });
        
        // Seleciona texto ao focar (facilita correção)
        input.addEventListener('focus', function() { this.select(); });
    });
});
</script>

{% endblock %}