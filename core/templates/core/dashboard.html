{% extends 'core/base.html' %}

{% block content %}
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-none justify-content-center align-items-center" style="z-index: 9999;">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-2 fw-bold text-primary">Processando dados...</p>
    </div>
</div>

<div class="container-fluid py-4">

    <div class="card border-0 shadow-sm mb-4 rounded-4 overflow-hidden">
        <div class="card-body bg-white p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h5 class="mb-0 text-primary fw-bold text-truncate" title="{{ nome_filtro }}">
                        <i class="bi bi-sliders2 me-2"></i>{{ nome_filtro }}
                    </h5>
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.65rem; letter-spacing: 1px;">Painel de Controle</small>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'gerar_relatorio_proficiencia' %}?avaliacao={{ avaliacao_selecionada|default:'' }}&turma={{ turma_selecionada|default:'' }}&aluno={{ aluno_selecionado|default:'' }}&disciplina={{ disciplina_selecionada|default:'' }}&serie={{ serie_selecionada|default:'' }}" 
                       target="_blank" class="btn btn-primary fw-bold rounded-pill px-4 shadow-sm">
                       <i class="bi bi-file-earmark-pdf-fill me-2"></i> Relatório
                    </a>
                    <a href="{% url 'dashboard' %}" class="btn btn-light text-danger border-0 hover-danger rounded-pill px-3 shadow-sm" title="Limpar filtros">
                        <i class="bi bi-eraser-fill"></i>
                    </a>
                </div>
            </div>

            <form method="get" class="row g-3" id="filterForm" onsubmit="mostrarLoading()">
                <div class="col-lg-3 border-end">
                    <label class="small text-muted fw-bold mb-2">PERÍODO</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-0"><i class="bi bi-calendar-range"></i></span>
                        <input type="date" name="data_inicio" value="{{ data_inicio|default:'' }}" class="form-control bg-light border-0 fw-bold text-secondary">
                        <input type="date" name="data_fim" value="{{ data_fim|default:'' }}" class="form-control bg-light border-0 fw-bold text-secondary">
                    </div>
                </div>
                <div class="col-lg-5 border-end">
                    <label class="small text-muted fw-bold mb-2">ENTURMAMENTO</label>
                    <div class="d-flex gap-2">
                        <select name="serie" class="form-select form-select-sm bg-light border-0 fw-bold text-dark">
                            <option value="">Todas Séries</option>
                            <option value="1" {% if serie_selecionada == "1" %}selected{% endif %}>1º Ano</option>
                            <option value="2" {% if serie_selecionada == "2" %}selected{% endif %}>2º Ano</option>
                            <option value="3" {% if serie_selecionada == "3" %}selected{% endif %}>3º Ano</option>
                        </select>
                        <select name="turma" class="form-select form-select-sm bg-light border-0 fw-bold text-dark">
                            <option value="">Todas Turmas</option>
                            {% for t in turmas_da_serie %}
                                <option value="{{ t.id }}" {% if turma_selecionada == t.id|stringformat:"s" %}selected{% endif %}>{{ t.nome }}</option>
                            {% endfor %}
                        </select>
                        <select name="aluno" class="form-select form-select-sm bg-light border-0 fw-bold text-dark">
                            <option value="">Todos Alunos</option>
                            {% for a in alunos_da_turma %}
                                <option value="{{ a.id }}" {% if aluno_selecionado == a.id|stringformat:"s" %}selected{% endif %}>{{ a.nome_completo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-lg-4">
                    <label class="small text-muted fw-bold mb-2">CONTEÚDO</label>
                    <div class="d-flex gap-2">
                        <select name="disciplina" class="form-select form-select-sm bg-primary bg-opacity-10 border-0 fw-bold text-primary">
                            <option value="">Todas Matérias</option>
                            {% for d in disciplinas %}
                                <option value="{{ d.id }}" {% if disciplina_selecionada == d.id|stringformat:"s" %}selected{% endif %}>{{ d.nome }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary btn-sm px-4 fw-bold rounded-pill shadow-sm">
                            <i class="bi bi-filter me-1"></i> Filtrar
                        </button>
                    </div>
                    <div class="mt-2">
                         <select name="avaliacao" class="form-select form-select-sm bg-primary bg-opacity-10 border-0 fw-bold text-primary w-100" onchange="mostrarLoading(); this.form.submit()">
                            <option value="">Todas Provas (Selecione para ver o Mapa de Calor)</option>
                            {% for av in avaliacoes_todas %}
                                <option value="{{ av.id }}" {% if avaliacao_selecionada == av.id|stringformat:"s" %}selected{% endif %}>{{ av.titulo }} - {{ av.turma.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 bg-primary bg-opacity-10 border-start border-primary border-4">
                <div class="card-body p-3">
                    <h6 class="text-primary fw-bold text-uppercase small mb-1">Avaliados</h6>
                    <h3 class="fw-bold text-dark mb-0">{{ total_avaliacoes_contagem }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 bg-success bg-opacity-10 border-start border-success border-4">
                <div class="card-body p-3">
                    <h6 class="text-success fw-bold text-uppercase small mb-1">Média Geral</h6>
                    <h3 class="fw-bold text-dark mb-0">{{ media_geral|default:"-" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 bg-warning bg-opacity-10 border-start border-warning border-4">
                <div class="card-body p-3">
                    <h6 class="text-warning fw-bold text-uppercase small mb-1">Nível Predominante</h6>
                    <h3 class="fw-bold text-dark mb-0 fs-5">{{ nivel_predominante|default:"-" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 bg-info bg-opacity-10 border-start border-info border-4">
                <div class="card-body p-3">
                    <h6 class="text-info fw-bold text-uppercase small mb-1">Provas Aplicadas</h6>
                    <h3 class="fw-bold text-dark mb-0">{{ qtd_provas }}</h3>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-pills mb-4 gap-2 p-1 bg-white rounded-pill shadow-sm d-inline-flex" id="dashboardTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active rounded-pill fw-bold px-4" data-bs-toggle="pill" data-bs-target="#visao-geral"><i class="bi bi-speedometer2 me-2"></i>Visão Geral</button></li>
        <li class="nav-item"><button class="nav-link rounded-pill fw-bold px-4" data-bs-toggle="pill" data-bs-target="#pedagogico"><i class="bi bi-eyeglasses me-2"></i>Pedagógico</button></li>
        <li class="nav-item"><button class="nav-link rounded-pill fw-bold px-4" data-bs-toggle="pill" data-bs-target="#mapa"><i class="bi bi-grid-3x3-gap-fill me-2"></i>Mapa de Calor</button></li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
        
        <div class="tab-pane fade show active" id="visao-geral">
            <div class="row g-4 mb-4">
                <div class="col-lg-8">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold text-dark mb-0"><i class="bi bi-graph-up-arrow me-2 text-primary"></i>Evolução da Turma</h6>
                            <small class="text-muted"><span style="color: #dc3545; font-weight: bold;">---</span> Meta (70%)</small>
                        </div>
                        <div class="card-body">
                            <div style="height: 300px;"><canvas id="chartEvolucao"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-white py-3 border-0">
                            <h6 class="fw-bold text-dark mb-0"><i class="bi bi-pie-chart-fill me-2 text-primary"></i>Níveis de Aprendizado</h6>
                        </div>
                        <div class="card-body text-center position-relative">
                            <div style="height: 250px;"><canvas id="chartPizza" style="cursor: pointer;"></canvas></div>
                            <small class="text-muted mt-3 d-block"><i class="bi bi-cursor"></i> Clique nas fatias para detalhes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pedagogico">
            <div class="card shadow-sm border-0 mb-4 rounded-4">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold text-dark mb-0"><i class="bi bi-bar-chart-fill me-2 text-primary"></i>Proficiência por Descritor</h6>
                    <small class="text-primary fw-bold blink-soft"><i class="bi bi-mouse-fill me-1"></i>Clique nas barras para ver os alunos</small>
                </div>
                <div class="card-body">
                    {% if labels_proficiencia %}
                        <div style="height: 350px;"><canvas id="chartProficiencia" style="cursor: pointer;"></canvas></div>
                    {% else %}
                        <div class="text-center py-5 opacity-50"><i class="bi bi-bar-chart display-4"></i><p class="mt-2">Sem dados para exibir.</p></div>
                    {% endif %}
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-success bg-opacity-10 border-0 py-3"><h6 class="fw-bold text-success mb-0"><i class="bi bi-trophy-fill me-2"></i>Pontos Fortes</h6></div>
                        <ul class="list-group list-group-flush">
                            {% for q in ranking_facil|slice:":5" %}
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 border-bottom">
                                <div class="me-3 overflow-hidden">
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 mb-1">{{ q.desc }}</span>
                                    <div class="text-muted small text-truncate" title="{{ q.texto }}">{{ q.texto }}</div>
                                </div>
                                <span class="badge bg-success rounded-pill">{{ q.percentual_acerto }}%</span>
                            </li>
                            {% empty %}<li class="list-group-item text-center text-muted py-4">Nenhum dado.</li>{% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-danger bg-opacity-10 border-0 py-3"><h6 class="fw-bold text-danger mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Pontos de Atenção</h6></div>
                        <ul class="list-group list-group-flush">
                            {% for q in ranking_dificil|slice:":5" %}
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 border-bottom">
                                <div class="me-3 overflow-hidden">
                                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 mb-1">{{ q.desc }}</span>
                                    <div class="text-muted small text-truncate" title="{{ q.texto }}">{{ q.texto }}</div>
                                </div>
                                <span class="badge bg-danger rounded-pill">{{ q.percentual_erro }}%</span>
                            </li>
                            {% empty %}<li class="list-group-item text-center text-muted py-4">Nenhum dado.</li>{% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="mapa">
            {% if avaliacao_selecionada and itens_heatmap %}
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px;">
                        <table class="table table-bordered mb-0" style="font-size: 0.85rem;">
                            <thead class="bg-light text-center align-middle" style="position: sticky; top: 0; z-index: 1020;">
                                <tr>
                                    <th class="ps-3 text-start bg-light border-0 sticky-col" style="min-width: 250px; left: 0; z-index: 1030;">ALUNO</th>
                                    <th class="bg-light border-0">NOTA</th>
                                    {% for item in itens_heatmap %}
                                    <th class="py-2" style="width: 40px;" data-bs-toggle="tooltip" title="{{ item.descritor.codigo }} - {{ item.descritor.descricao }}">
                                        <div class="small text-muted fw-bold">Q{{ item.numero }}</div>
                                        <span class="badge bg-light text-dark border" style="font-size: 0.6rem; cursor: help;">{{ item.descritor.codigo|default:'-' }}</span>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for linha in matriz_calor %}
                                <tr>
                                    <td class="fw-bold ps-3 text-truncate bg-white sticky-col" style="max-width: 250px; left: 0;">{{ linha.aluno.nome_completo }}</td>
                                    <td class="text-center fw-bold {% if linha.nota >= 6 %}text-success{% else %}text-danger{% endif %}">{{ linha.nota }}</td>
                                    {% for q in linha.questoes %}
                                    <td class="text-center p-0 position-relative">
                                        <div class="d-flex align-items-center justify-content-center" style="height: 35px;" title="{% if q.item.descritor %}{{ q.item.descritor.descricao }}{% else %}Sem descritor{% endif %}">
                                            {% if q.acertou %}
                                                <div class="bg-success rounded-1 shadow-sm" style="width: 18px; height: 18px;"></div>
                                            {% else %}
                                                <div class="bg-danger bg-opacity-75 rounded-1 shadow-sm" style="width: 18px; height: 18px;"></div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-grid-3x3-gap display-4 text-muted opacity-25"></i>
                <h4 class="mt-3 text-muted">Selecione uma Prova Específica</h4>
                <p class="text-muted small">O mapa de calor detalhado exige que você escolha uma "Prova Específica" nos filtros acima.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalhesPizza" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalTitulo">Alunos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-2"><ul class="list-group list-group-flush" id="listaAlunosModal"></ul></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalRaioX" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-header border-0 pb-0 bg-danger bg-opacity-10">
                <div>
                    <h5 class="modal-title fw-bold text-danger" id="modalTituloRaioX">Ponto de Atenção</h5>
                    <small class="text-muted">Alunos que erraram este descritor</small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-2">
                <ul class="list-group list-group-flush" id="listaAlunosRaioX"></ul>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill btn-sm" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function mostrarLoading() {
        document.getElementById('loadingOverlay').classList.remove('d-none');
        document.getElementById('loadingOverlay').classList.add('d-flex');
    }

    document.addEventListener("DOMContentLoaded", function() {
        const COLORS = { azul: '#0d6efd', verde: '#198754', amarelo: '#ffc107', vermelho: '#dc3545' };
        const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } };
        
        const dadosDetalhados = {{ detalhes_pizza_json|default:"{}"|safe }};
        // NÃO USAMOS MAIS 'dadosRaioX' DO DJANGO AQUI, POIS ERA PESADO DEMAIS.
        
        let pizzaChart, proficienciaChart, evolucaoChart;

        // --- FUNÇÃO MODAL PIZZA ---
        window.abrirModalAlunos = function(categoria) {
            const modalEl = document.getElementById('modalDetalhesPizza');
            const modal = new bootstrap.Modal(modalEl);
            const lista = document.getElementById('listaAlunosModal');
            document.getElementById('modalTitulo').innerText = `Nível: ${categoria}`;
            lista.innerHTML = '';
            
            const alunos = dadosDetalhados[categoria] || [];
            
            alunos.forEach(aluno => {
                let badgeClass = 'bg-secondary';
                if(aluno.nota >= 9) badgeClass = 'bg-primary'; 
                else if(aluno.nota >= 7) badgeClass = 'bg-success'; 
                else if(aluno.nota >= 5) badgeClass = 'bg-warning text-dark'; 
                else badgeClass = 'bg-danger'; 

                lista.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 py-2">
                        <div><div class="fw-bold text-dark">${aluno.nome}</div><small class="text-muted">${aluno.turma}</small></div>
                        <span class="badge ${badgeClass} rounded-pill fs-6">${aluno.nota}</span>
                    </li>`;
            });
            if (!lista.innerHTML) lista.innerHTML = '<li class="text-muted text-center py-3">Nenhum aluno nesta categoria.</li>';
            modal.show();
        };

        // --- FUNÇÃO MODAL RAIO-X (VIA AJAX - RÁPIDO!) ---
        window.abrirModalRaioX = function(descritor) {
            const modalEl = document.getElementById('modalRaioX');
            const modal = new bootstrap.Modal(modalEl);
            const lista = document.getElementById('listaAlunosRaioX');
            const titulo = document.getElementById('modalTituloRaioX');
            
            titulo.innerText = `Carregando ${descritor}...`;
            lista.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>';
            modal.show();

            // Pega os filtros atuais da URL para que o raio-x obedeça (Turma, Série, etc)
            const params = new URLSearchParams(window.location.search);
            params.append('descritor', descritor);

            // Chama a nova API
            fetch(`/api/raio-x/?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    titulo.innerText = `Dificuldade em ${descritor}`;
                    lista.innerHTML = '';
                    
                    if (data.alunos && data.alunos.length > 0) {
                        data.alunos.forEach(alunoStr => {
                            lista.innerHTML += `
                                <li class="list-group-item d-flex align-items-center border-0 px-0 py-2">
                                    <i class="bi bi-person-x-fill text-danger me-3 fs-5"></i>
                                    <div class="fw-bold text-dark">${alunoStr}</div>
                                </li>`;
                        });
                    } else {
                        lista.innerHTML = '<li class="text-success text-center py-3 fw-bold"><i class="bi bi-check-circle me-2"></i>Ninguém errou este descritor neste filtro!</li>';
                    }
                })
                .catch(err => {
                    lista.innerHTML = '<li class="text-danger text-center">Erro ao carregar dados. Tente novamente.</li>';
                    console.error(err);
                });
        };

        // Pizza Chart
        const ctxPizza = document.getElementById('chartPizza');
        if (ctxPizza) {
            pizzaChart = new Chart(ctxPizza, {
                type: 'doughnut',
                data: {
                    labels: ['Avançado', 'Adequado', 'Intermediário', 'Crítico'],
                    datasets: [{
                        data: {{ dados_pizza|default:"[]"|safe }},
                        backgroundColor: [COLORS.azul, COLORS.verde, COLORS.amarelo, COLORS.vermelho],
                        borderWidth: 0
                    }]
                },
                options: {
                    ...chartOptions, cutout: '70%',
                    onClick: (evt, el) => { 
                        if(el.length > 0) {
                            const cats = ['Avançado', 'Adequado', 'Intermediário', 'Crítico'];
                            abrirModalAlunos(cats[el[0].index]); 
                        }
                    }
                }
            });
        }

        // Proficiência Chart
        const ctxProf = document.getElementById('chartProficiencia');
        if (ctxProf) {
            proficienciaChart = new Chart(ctxProf, {
                type: 'bar',
                data: {
                    labels: {{ labels_proficiencia|default:"[]"|safe }},
                    datasets: [{
                        label: 'Acerto (%)',
                        data: {{ dados_proficiencia|default:"[]"|safe }},
                        backgroundColor: function(context) {
                            const val = context.raw;
                            if (val >= 90) return COLORS.azul;
                            if (val >= 70) return COLORS.verde;
                            if (val >= 50) return COLORS.amarelo;
                            return COLORS.vermelho;
                        },
                        borderRadius: 6
                    }]
                },
                options: { 
                    ...chartOptions, 
                    scales: { y: { beginAtZero: true, max: 100 } }, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: { callbacks: { footer: () => 'Clique para ver alunos' } } 
                    },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const descritor = proficienciaChart.data.labels[index];
                            abrirModalRaioX(descritor); // CHAMA A API
                        }
                    }
                }
            });
        }

        // Evolução Chart
        const ctxEvo = document.getElementById('chartEvolucao');
        if (ctxEvo) {
             const labels = {{ labels_evolucao|default:"[]"|safe }};
             const dados = {{ dados_evolucao|default:"[]"|safe }};
             const metaData = new Array(dados.length).fill(70); 

             evolucaoChart = new Chart(ctxEvo, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Média da Turma (%)', data: dados, borderColor: COLORS.azul, backgroundColor: 'rgba(13, 110, 253, 0.1)', tension: 0.4, fill: true },
                        { label: 'Meta', data: metaData, borderColor: '#dc3545', borderWidth: 2, borderDash: [5, 5], pointRadius: 0 }
                    ]
                },
                options: { ...chartOptions, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', () => {
                if(pizzaChart) pizzaChart.resize();
                if(proficienciaChart) proficienciaChart.resize();
                if(evolucaoChart) evolucaoChart.resize();
            });
        });
    });
</script>

<style>
    .hover-danger:hover { background-color: #dc3545; color: white !important; border-color: #dc3545 !important; }
    .sticky-col { position: -webkit-sticky; position: sticky; background-color: white; z-index: 5; border-right: 2px solid #dee2e6 !important; }
    @keyframes pulse-soft { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
    .blink-soft { animation: pulse-soft 2s infinite; cursor: pointer; }
</style>
{% endblock %}