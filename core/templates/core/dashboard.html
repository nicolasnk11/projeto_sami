{% extends 'core/base.html' %}

{% block content %}
<div class="container-fluid py-4">

    <div class="card border-0 shadow-sm mb-4 rounded-4 overflow-hidden">
        <div class="card-body bg-white p-3">
            <form method="get" class="row g-2 align-items-center">
                
                <div class="col-xl-2 col-lg-3 border-end pe-3">
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">Analisando</small>
                    <h5 class="mb-0 text-primary fw-bold text-truncate" title="{{ nome_filtro }}">
                        {{ nome_filtro }}
                    </h5>
                </div>

                <div class="col-xl-8 col-lg-9">
                    <div class="d-flex flex-wrap gap-2">
                        
                        <div class="input-group input-group-sm" style="max-width: 260px;">
                            <span class="input-group-text bg-light border-0"><i class="bi bi-calendar3"></i></span>
                            <input type="date" name="data_inicio" value="{{ data_inicio|default:'' }}" class="form-control bg-light border-0 text-secondary fw-bold" title="Data In√≠cio" onchange="this.form.submit()">
                            <input type="date" name="data_fim" value="{{ data_fim|default:'' }}" class="form-control bg-light border-0 text-secondary fw-bold" title="Data Fim" onchange="this.form.submit()">
                        </div>

                        <select name="serie" class="form-select form-select-sm bg-light border-0 fw-bold text-secondary flex-grow-1" style="min-width: 100px;" onchange="this.form.submit()">
                            <option value="">üè´ S√©rie</option>
                            <option value="1" {% if serie_selecionada == "1" %}selected{% endif %}>1¬∫ Ano</option>
                            <option value="2" {% if serie_selecionada == "2" %}selected{% endif %}>2¬∫ Ano</option>
                            <option value="3" {% if serie_selecionada == "3" %}selected{% endif %}>3¬∫ Ano</option>
                        </select>

                        <select name="turma" class="form-select form-select-sm bg-light border-0 fw-bold text-secondary flex-grow-1" style="min-width: 120px;" onchange="this.form.submit()">
                            <option value="">üë• Turma</option>
                            {% for t in turmas_da_serie %}
                                <option value="{{ t.id }}" {% if turma_selecionada == t.id|stringformat:"s" %}selected{% endif %}>{{ t.nome }}</option>
                            {% endfor %}
                        </select>

                        <select name="disciplina" class="form-select form-select-sm bg-light border-0 fw-bold text-secondary flex-grow-1" style="min-width: 120px;" onchange="this.form.submit()">
                            <option value="">üìö Mat√©ria</option>
                            {% for d in disciplinas %}
                                <option value="{{ d.id }}" {% if disciplina_selecionada == d.id|stringformat:"s" %}selected{% endif %}>{{ d.nome }}</option>
                            {% endfor %}
                        </select>

                        <select name="avaliacao" class="form-select form-select-sm bg-light border-0 fw-bold text-secondary flex-grow-1" style="min-width: 180px;" onchange="this.form.submit()">
                            <option value="">üìã Prova Espec√≠fica</option>
                            {% for av in avaliacoes_todas %}
                                <option value="{{ av.id }}" {% if avaliacao_selecionada == av.id|stringformat:"s" %}selected{% endif %}>{{ av.titulo }} - {{ av.turma.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-xl-2 col-lg-12 text-end d-flex justify-content-end gap-2">
                    <button type="submit" name="export" value="csv" class="btn btn-sm btn-success text-white fw-bold shadow-sm" title="Baixar Planilha Excel">
                        <i class="bi bi-file-earmark-spreadsheet-fill"></i> <span class="d-none d-xl-inline">Excel</span>
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-sm btn-light text-danger fw-bold border hover-danger" title="Limpar Filtros">
                        <i class="bi bi-trash"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <ul class="nav nav-pills mb-4 gap-2 p-1 bg-white rounded-pill shadow-sm d-inline-flex" id="dashboardTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active rounded-pill fw-bold px-4" data-bs-toggle="pill" data-bs-target="#visao-geral">
                <i class="bi bi-speedometer2 me-2"></i>Vis√£o Geral
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link rounded-pill fw-bold px-4" data-bs-toggle="pill" data-bs-target="#pedagogico">
                <i class="bi bi-eyeglasses me-2"></i>Pedag√≥gico
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link rounded-pill fw-bold px-4" data-bs-toggle="pill" data-bs-target="#mapa">
                <i class="bi bi-grid-3x3-gap-fill me-2"></i>Mapa de Calor
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
        
        <div class="tab-pane fade show active" id="visao-geral">
            <div class="row g-4 mb-4">
                <div class="col-lg-8">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold text-primary mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Evolu√ß√£o da Turma</h6>
                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">Meta Escola: 70%</span>
                        </div>
                        <div class="card-body">
                            <div style="height: 300px;">
                                <canvas id="chartEvolucao"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-white py-3 border-0">
                            <h6 class="fw-bold text-dark mb-0"><i class="bi bi-pie-chart-fill me-2"></i>N√≠veis de Aprendizado</h6>
                        </div>
                        <div class="card-body text-center position-relative">
                            <div style="height: 250px;">
                                <canvas id="chartPizza" style="cursor: pointer;"></canvas>
                            </div>
                            <small class="text-muted mt-3 d-block"><i class="bi bi-cursor"></i> Clique nas fatias para ver alunos</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pedagogico">
            
            <div class="card shadow-sm border-0 mb-4 rounded-4">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h6 class="fw-bold text-dark mb-0"><i class="bi bi-bar-chart-fill me-2"></i>Habilidades (Descritores)</h6>
                    
                    <a href="{% url 'gerar_relatorio_proficiencia' %}?{{ request.GET.urlencode }}" 
                       class="btn btn-sm btn-danger rounded-pill px-3 shadow-sm hover-scale text-white fw-bold">
                        <i class="bi bi-file-pdf-fill me-1"></i> Baixar Relat√≥rio PDF
                    </a>
                </div>
                <div class="card-body">
                    {% if labels_proficiencia %}
                        <div style="height: 350px;">
                            <canvas id="chartProficiencia"></canvas>
                        </div>
                    {% else %}
                        <div class="text-center py-5 opacity-50">
                            <i class="bi bi-bar-chart display-4"></i>
                            <p class="mt-2">Sem dados de habilidades para exibir. Selecione uma prova ou disciplina.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-success bg-opacity-10 border-0 py-3">
                            <h6 class="fw-bold text-success mb-0"><i class="bi bi-check-circle-fill me-2"></i>Pontos Fortes (Top Acertos)</h6>
                        </div>
                        <ul class="list-group list-group-flush">
                            {% for q in ranking_facil|slice:":5" %}
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 border-bottom">
                                <div class="me-3 overflow-hidden">
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 mb-1">{{ q.desc }}</span>
                                    <div class="text-muted small text-truncate" title="{{ q.texto }}">{{ q.texto }}</div>
                                </div>
                                <span class="badge bg-success rounded-pill">{{ q.percentual_acerto }}%</span>
                            </li>
                            {% empty %}
                            <li class="list-group-item text-center text-muted py-4">Sem dados.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-danger bg-opacity-10 border-0 py-3">
                            <h6 class="fw-bold text-danger mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Pontos de Aten√ß√£o (Top Erros)</h6>
                        </div>
                        <ul class="list-group list-group-flush">
                            {% for q in ranking_dificil|slice:":5" %}
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 border-bottom">
                                <div class="me-3 overflow-hidden">
                                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 mb-1">{{ q.desc }}</span>
                                    <div class="text-muted small text-truncate" title="{{ q.texto }}">{{ q.texto }}</div>
                                </div>
                                <span class="badge bg-danger rounded-pill">{{ q.percentual_erro }}% Erro</span>
                            </li>
                            {% empty %}
                            <li class="list-group-item text-center text-muted py-4">Sem dados.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="mapa">
            {% if avaliacao_selecionada and itens_heatmap %}
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0" style="font-size: 0.85rem;">
                            <thead class="bg-light text-center align-middle sticky-top" style="z-index: 10;">
                                <tr>
                                    <th class="ps-3 text-start bg-white border-0" style="min-width: 200px;">ALUNO</th>
                                    <th class="bg-white border-0">NOTA</th>
                                    {% for item in itens_heatmap %}
                                    <th class="py-2" style="width: 40px;" data-bs-toggle="tooltip" title="{{ item.descritor.codigo }} - {{ item.descritor.descricao }}">
                                        <div class="small text-muted fw-bold">Q{{ item.numero }}</div>
                                        <span class="badge bg-light text-dark border" style="font-size: 0.6rem; cursor: help;">
                                            {{ item.descritor.codigo|default:'-' }}
                                        </span>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for linha in matriz_calor %}
                                <tr>
                                    <td class="fw-bold ps-3 text-truncate" style="max-width: 200px;">{{ linha.aluno.nome_completo }}</td>
                                    <td class="text-center fw-bold {% if linha.nota >= 6 %}text-success{% else %}text-danger{% endif %}">{{ linha.nota }}</td>
                                    {% for q in linha.questoes %}
                                    <td class="text-center p-0 position-relative">
                                        <div class="d-flex align-items-center justify-content-center" style="height: 35px;"
                                             data-bs-toggle="tooltip" 
                                             title="{% if q.item.descritor %}{{ q.item.descritor.descricao }}{% else %}Sem descritor{% endif %}">
                                            {% if q.acertou %}
                                                <div class="bg-success rounded-1 shadow-sm" style="width: 18px; height: 18px;"></div>
                                            {% else %}
                                                <div class="bg-danger bg-opacity-75 rounded-1 shadow-sm" style="width: 18px; height: 18px;"></div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-grid-3x3-gap display-4 text-muted opacity-25"></i>
                <h4 class="mt-3 text-muted">Selecione uma Prova Espec√≠fica</h4>
                <p class="text-muted small">O mapa de calor detalhado exige que voc√™ escolha uma "Prova Espec√≠fica" nos filtros acima.</p>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<div class="modal fade" id="modalDetalhesPizza" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalTitulo">Alunos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-2">
                <ul class="list-group list-group-flush" id="listaAlunosModal">
                    </ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Inicializa Tooltips do Bootstrap (Necess√°rio para o Heatmap)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // Configura√ß√£o Comum dos Gr√°ficos
        const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } };
        
        // Dados vindos do Django (JSON)
        const dadosDetalhados = {{ detalhes_pizza_json|default:"{}"|safe }};
        
        let pizzaChart, proficienciaChart, evolucaoChart;

        // L√≥gica do Modal (Lista de Alunos)
        window.abrirModalAlunos = function(categoria) {
            const modalEl = document.getElementById('modalDetalhesPizza');
            const modal = new bootstrap.Modal(modalEl);
            const lista = document.getElementById('listaAlunosModal');
            document.getElementById('modalTitulo').innerText = `Alunos - ${categoria}`;
            lista.innerHTML = '';
            
            const alunos = dadosDetalhados[categoria] || [];
            
            alunos.forEach(aluno => {
                let badgeColor = 'bg-light text-dark';
                if(aluno.nota >= 8) badgeColor = 'bg-success text-white';
                else if(aluno.nota < 6) badgeColor = 'bg-danger text-white';

                lista.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 py-2">
                        <div>
                            <div class="fw-bold text-dark">${aluno.nome}</div>
                            <small class="text-muted">${aluno.turma}</small>
                        </div>
                        <span class="badge ${badgeColor} border">${aluno.nota}</span>
                    </li>`;
            });
            
            if (!lista.innerHTML) lista.innerHTML = '<li class="text-muted text-center py-3">Nenhum aluno nesta categoria.</li>';
            modal.show();
        };

        // 1. Gr√°fico de Pizza (N√≠veis)
        const ctxPizza = document.getElementById('chartPizza');
        if (ctxPizza) {
            pizzaChart = new Chart(ctxPizza, {
                type: 'doughnut',
                data: {
                    labels: ['Adequado', 'Intermedi√°rio', 'Cr√≠tico', 'M. Cr√≠tico'],
                    datasets: [{
                        data: {{ dados_pizza|default:"[]"|safe }},
                        backgroundColor: ['#198754', '#ffc107', '#dc3545', '#212529'],
                        borderWidth: 0
                    }]
                },
                options: {
                    ...chartOptions, cutout: '70%',
                    onClick: (evt, el) => { 
                        if(el.length > 0) {
                            // Mapeia o √≠ndice clicado para o nome da categoria
                            const categorias = ['Adequado', 'Intermedi√°rio', 'Cr√≠tico', 'Muito Cr√≠tico'];
                            abrirModalAlunos(categorias[el[0].index]); 
                        }
                    }
                }
            });
        }

        // 2. Gr√°fico de Profici√™ncia (Barras)
        const ctxProf = document.getElementById('chartProficiencia');
        if (ctxProf) {
            proficienciaChart = new Chart(ctxProf, {
                type: 'bar',
                data: {
                    labels: {{ labels_proficiencia|default:"[]"|safe }},
                    datasets: [{
                        label: 'Acerto (%)',
                        data: {{ dados_proficiencia|default:"[]"|safe }},
                        backgroundColor: function(context) {
                            const val = context.raw;
                            if (val >= 80) return '#198754'; // Verde
                            if (val >= 60) return '#ffc107'; // Amarelo
                            if (val >= 21) return '#dc3545'; // Vermelho
                            return '#212529'; // Preto
                        },
                        borderRadius: 6
                    }]
                },
                options: { 
                    ...chartOptions, 
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // 3. Gr√°fico de Evolu√ß√£o (Linha com Meta)
        const ctxEvo = document.getElementById('chartEvolucao');
        if (ctxEvo) {
            const dadosReais = {{ dados_evolucao|default:"[]"|safe }};
            // Cria linha de meta fixa em 70%
            const metaDados = new Array(dadosReais.length).fill(70);

            evolucaoChart = new Chart(ctxEvo, {
                type: 'line',
                data: {
                    labels: {{ labels_evolucao|default:"[]"|safe }},
                    datasets: [
                        {
                            label: 'M√©dia da Turma (%)',
                            data: dadosReais,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Meta Escola (70%)',
                            data: metaDados,
                            borderColor: '#198754',
                            borderDash: [5, 5], // Pontilhado
                            pointRadius: 0,
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: { ...chartOptions, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        // Ajuste de Redimensionamento dos Gr√°ficos ao Trocar de Aba
        document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', () => {
                if(pizzaChart) pizzaChart.resize();
                if(proficienciaChart) proficienciaChart.resize();
                if(evolucaoChart) evolucaoChart.resize();
            });
        });
    });
</script>

<style>
    .hover-danger:hover { background-color: #dc3545; color: white !important; border-color: #dc3545 !important; }
    .hover-scale:hover { transform: scale(1.05); transition: transform 0.2s; }
</style>

{% endblock %}