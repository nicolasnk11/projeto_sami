{% extends 'core/base.html' %}

{% block content %}
<div class="container-fluid py-4">

    <div class="card border-0 shadow-sm mb-4 rounded-4 overflow-hidden">
        <div class="card-body bg-white p-4">
            <form method="get" class="row g-3 align-items-center">
                
                <div class="col-md-3 border-end">
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px;">Visualizando</small>
                    <h5 class="mb-0 text-primary fw-bold text-truncate" title="{{ nome_filtro }}">
                        <i class="bi bi-funnel-fill me-1"></i> {{ nome_filtro }}
                    </h5>
                </div>

                <div class="col-md-7">
                    <div class="d-flex gap-2">
                        <select name="avaliacao" class="form-select form-select-sm bg-light border-0 fw-bold text-secondary" onchange="this.form.submit()">
                            <option value="">üìã Selecionar Prova (Para Heatmap)</option>
                            {% for av in avaliacoes_todas %}
                                <option value="{{ av.id }}" {% if avaliacao_selecionada == av.id|stringformat:"s" %}selected{% endif %}>{{ av.titulo }} - {{ av.turma.nome }}</option>
                            {% endfor %}
                        </select>

                        <select name="serie" class="form-select form-select-sm bg-light border-0 fw-bold text-secondary" onchange="this.form.submit()">
                            <option value="">üè´ S√©rie Geral</option>
                            <option value="1" {% if serie_selecionada == "1" %}selected{% endif %}>1¬∫ Ano</option>
                            <option value="2" {% if serie_selecionada == "2" %}selected{% endif %}>2¬∫ Ano</option>
                            <option value="3" {% if serie_selecionada == "3" %}selected{% endif %}>3¬∫ Ano</option>
                        </select>

                        <select name="turma" class="form-select form-select-sm bg-light border-0 fw-bold text-secondary" onchange="this.form.submit()">
                            <option value="">üë• Turma</option>
                            {% for t in turmas_da_serie %}
                                <option value="{{ t.id }}" {% if turma_selecionada == t.id|stringformat:"s" %}selected{% endif %}>{{ t.nome }}</option>
                            {% endfor %}
                        </select>

                        <select name="disciplina" class="form-select form-select-sm bg-light border-0 fw-bold text-secondary" onchange="this.form.submit()">
                            <option value="">üìö Mat√©ria</option>
                            {% for d in disciplinas %}
                                <option value="{{ d.id }}" {% if disciplina_selecionada == d.id|stringformat:"s" %}selected{% endif %}>{{ d.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-md-2 text-end">
                    <a href="{% url 'dashboard' %}" class="btn btn-sm btn-light text-muted fw-bold border hover-danger w-100">
                        <i class="bi bi-x-circle"></i> Limpar Filtros
                    </a>
                </div>
            </form>
        </div>
    </div>

    <ul class="nav nav-pills mb-4 gap-2 p-1 bg-white rounded-pill shadow-sm d-inline-flex" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active rounded-pill fw-bold px-4" id="visao-geral-tab" data-bs-toggle="pill" data-bs-target="#visao-geral" type="button" role="tab">
                <i class="bi bi-speedometer2 me-2"></i>Vis√£o Geral
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill fw-bold px-4" id="pedagogico-tab" data-bs-toggle="pill" data-bs-target="#pedagogico" type="button" role="tab">
                <i class="bi bi-eyeglasses me-2"></i>Diagn√≥stico
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill fw-bold px-4" id="mapa-tab" data-bs-toggle="pill" data-bs-target="#mapa" type="button" role="tab">
                <i class="bi bi-grid-3x3-gap-fill me-2"></i>Mapa de Calor
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill fw-bold px-4" id="historico-tab" data-bs-toggle="pill" data-bs-target="#historico" type="button" role="tab">
                <i class="bi bi-archive me-2"></i>Hist√≥rico
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
        
        <div class="tab-pane fade show active" id="visao-geral" role="tabpanel">
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm h-100 text-white" style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); border-radius: 16px;">
                        <div class="card-body p-4 position-relative overflow-hidden">
                            <i class="bi bi-door-open position-absolute" style="font-size: 6rem; opacity: 0.1; right: -20px; top: -20px;"></i>
                            <h2 class="display-5 fw-bold mb-0">{{ total_turmas }}</h2>
                            <p class="mb-0 opacity-75 fw-medium">Turmas Ativas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm h-100 text-white" style="background: linear-gradient(135deg, #198754 0%, #146c43 100%); border-radius: 16px;">
                        <div class="card-body p-4 position-relative overflow-hidden">
                            <i class="bi bi-file-earmark-check position-absolute" style="font-size: 6rem; opacity: 0.1; right: -20px; top: -20px;"></i>
                            <h2 class="display-5 fw-bold mb-0">{{ total_avaliacoes_contagem }}</h2>
                            <p class="mb-0 opacity-75 fw-medium">Avalia√ß√µes Realizadas</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-8">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-white py-3 border-0">
                            <h6 class="fw-bold text-primary mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Evolu√ß√£o da M√©dia</h6>
                        </div>
                        <div class="card-body">
                            <div style="height: 300px;">
                                <canvas id="chartEvolucao"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-white py-3 border-0">
                            <h6 class="fw-bold text-dark mb-0"><i class="bi bi-pie-chart-fill me-2"></i>N√≠veis de Aprendizado</h6>
                        </div>
                        <div class="card-body text-center position-relative">
                            <div style="height: 250px;">
                                <canvas id="chartPizza" style="cursor: pointer;"></canvas>
                            </div>
                            <small class="text-muted mt-3 d-block"><i class="bi bi-info-circle"></i> Clique para ver alunos</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pedagogico" role="tabpanel">
            
            <div class="card shadow-sm border-0 mb-4 rounded-4">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold text-dark mb-0"><i class="bi bi-bar-chart-fill me-2"></i>Profici√™ncia por Descritor</h6>
                    <a href="{% url 'gerar_relatorio_proficiencia' %}?serie={{ serie_selecionada }}&turma={{ turma_selecionada }}&aluno={{ aluno_selecionado }}" class="btn btn-sm btn-danger rounded-pill px-3">
                        <i class="bi bi-file-pdf-fill me-1"></i> Baixar Relat√≥rio
                    </a>
                </div>
                <div class="card-body">
                    {% if labels_proficiencia %}
                        <div style="height: 350px;">
                            <canvas id="chartProficiencia"></canvas>
                        </div>
                    {% else %}
                        <div class="text-center py-5 opacity-50">Sem dados suficientes para gerar gr√°fico.</div>
                    {% endif %}
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-success bg-opacity-10 border-0 py-3">
                            <h6 class="fw-bold text-success mb-0"><i class="bi bi-check-circle-fill me-2"></i>Top Acertos (Conte√∫do Dominado)</h6>
                        </div>
                        <div class="card-body p-0">
                            <ul class="list-group list-group-flush">
                                {% for q in ranking_facil|slice:":5" %}
                                <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 border-bottom">
                                    <div class="me-3">
                                        <div class="fw-bold text-dark mb-1" style="font-size: 0.9rem;">{{ q.desc }}</div>
                                        <small class="text-muted d-block text-truncate" style="max-width: 300px;">{{ q.texto }}</small>
                                    </div>
                                    <span class="badge bg-success rounded-pill">{{ q.percentual_acerto }}%</span>
                                </li>
                                {% empty %}
                                <li class="list-group-item text-center text-muted py-4">Sem dados.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-danger bg-opacity-10 border-0 py-3">
                            <h6 class="fw-bold text-danger mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Top Erros (Aten√ß√£o Necess√°ria)</h6>
                        </div>
                        <div class="card-body p-0">
                            <ul class="list-group list-group-flush">
                                {% for q in ranking_dificil|slice:":5" %}
                                <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 border-bottom">
                                    <div class="me-3">
                                        <div class="fw-bold text-dark mb-1" style="font-size: 0.9rem;">{{ q.desc }}</div>
                                        <small class="text-muted d-block text-truncate" style="max-width: 300px;">{{ q.texto }}</small>
                                    </div>
                                    <span class="badge bg-danger rounded-pill">{{ q.percentual_erro }}% Erro</span>
                                </li>
                                {% empty %}
                                <li class="list-group-item text-center text-muted py-4">Sem dados.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 rounded-4 mb-5">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="fw-bold text-dark mb-0"><i class="bi bi-people-fill me-2"></i>Mapa de Interven√ß√£o (Quem precisa de ajuda?)</h6>
                </div>
                <div class="card-body">
                    <div class="accordion accordion-flush" id="accordionIntervencao">
                        {% for habilidade, dados in mapa_habilidades.items|slice:":5" %}
                        <div class="accordion-item border rounded-3 mb-2 overflow-hidden">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#hab{{ forloop.counter }}">
                                    <div class="d-flex justify-content-between w-100 pe-3 align-items-center">
                                        <span class="fw-bold text-dark small">{{ habilidade }}</span>
                                        <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill border border-danger border-opacity-25">
                                            {{ dados.criticas|length }} Alunos Cr√≠ticos
                                        </span>
                                    </div>
                                </button>
                            </h2>
                            <div id="hab{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordionIntervencao">
                                <div class="accordion-body">
                                    <h6 class="text-danger small fw-bold mb-2">Precisam de Refor√ßo:</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for nome in dados.criticas %}
                                            <span class="badge bg-white text-danger border border-danger p-2 fw-normal">{{ nome }}</span>
                                        {% empty %}
                                            <span class="text-muted small">Nenhum.</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4 text-muted">Sem dados para mapeamento.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="mapa" role="tabpanel">
            {% if avaliacao_selecionada and itens_heatmap %}
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0" style="font-size: 0.85rem;">
                            <thead class="bg-light text-center align-middle">
                                <tr>
                                    <th class="ps-3 text-start bg-white border-0" style="min-width: 200px;">ALUNO</th>
                                    <th class="bg-white border-0">NOTA</th>
                                    {% for item in itens_heatmap %}
                                    <th class="py-2" style="width: 40px;" title="Q.{{ item.numero }} - {{ item.descritor.descricao|default:'' }}">
                                        <div class="small text-muted fw-bold">Q{{ item.numero }}</div>
                                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25" style="font-size: 0.6rem;">
                                            {{ item.descritor.codigo|default:'-' }}
                                        </span>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for linha in matriz_calor %}
                                <tr>
                                    <td class="fw-bold ps-3 text-truncate" style="max-width: 200px;">{{ linha.aluno.nome_completo }}</td>
                                    <td class="text-center fw-bold {% if linha.nota >= 6 %}text-success{% else %}text-danger{% endif %}">{{ linha.nota }}</td>
                                    {% for q in linha.questoes %}
                                    <td class="text-center p-0">
                                        <div class="d-flex align-items-center justify-content-center" style="height: 35px;">
                                            {% if q.acertou %}
                                                <div class="bg-success rounded-1 shadow-sm" style="width: 18px; height: 18px;" title="Acertou"></div>
                                            {% else %}
                                                <div class="bg-danger bg-opacity-75 rounded-1 shadow-sm" style="width: 18px; height: 18px;" title="Errou"></div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-light text-center fw-bold small">
                                <tr>
                                    <td class="text-end pe-3">ACERTOS %</td>
                                    <td>-</td>
                                    {% for stat in stats_heatmap_footer %}
                                    <td class="{% if stat.perc < 50 %}text-danger{% else %}text-success{% endif %}">{{ stat.perc }}%</td>
                                    {% endfor %}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="d-flex gap-4 mt-3 ms-2">
                <div class="d-flex align-items-center gap-2">
                    <div class="rounded-1 bg-success shadow-sm" style="width: 15px; height: 15px;"></div>
                    <small class="text-muted">Acerto</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <div class="rounded-1 bg-danger bg-opacity-75 shadow-sm" style="width: 15px; height: 15px;"></div>
                    <small class="text-muted">Erro</small>
                </div>
            </div>

            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-grid-3x3-gap display-4 text-muted opacity-25"></i>
                <h4 class="mt-3 text-muted">Selecione uma Prova Espec√≠fica</h4>
                <p class="text-muted small">Utilize o filtro "Visualizando" no topo para escolher uma avalia√ß√£o.</p>
            </div>
            {% endif %}
        </div>

        <div class="tab-pane fade" id="historico" role="tabpanel">
            <div class="card shadow-sm border-0 rounded-4 overflow-hidden mb-5">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="fw-bold text-dark mb-0">Hist√≥rico de Avalia√ß√µes</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-secondary small text-uppercase">
                            <tr>
                                <th class="ps-4 py-3">T√≠tulo</th>
                                <th>Turma</th>
                                <th>Disciplina</th>
                                <th>Data</th>
                                <th class="text-end pe-4">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for av in avaliacoes_todas|slice:":10" %}
                            <tr>
                                <td class="ps-4 fw-bold text-dark">{{ av.titulo }}</td>
                                <td><span class="badge bg-light text-dark border">{{ av.turma.nome }}</span></td>
                                <td>{{ av.disciplina.nome }}</td>
                                <td>{{ av.data_aplicacao|date:"d/m/Y" }}</td>
                                <td class="text-end pe-4">
                                    <a href="?avaliacao={{ av.id }}" class="btn btn-sm btn-primary rounded-pill px-3">Ver Dados</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center py-5 text-muted">Nenhuma avalia√ß√£o encontrada.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="modalDetalhesPizza" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalTitulo">Alunos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-2">
                <ul class="list-group list-group-flush" id="listaAlunosModal"></ul>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } };
        const dadosDetalhados = {{ detalhes_pizza_json|default:"{}"|safe }};
        
        let pizzaChart, proficienciaChart, evolucaoChart;

        // Fun√ß√£o Modal
        window.abrirModalAlunos = function(categoria) {
            const modalEl = document.getElementById('modalDetalhesPizza');
            const modal = new bootstrap.Modal(modalEl);
            const lista = document.getElementById('listaAlunosModal');
            
            document.getElementById('modalTitulo').innerText = `Alunos - ${categoria}`;
            lista.innerHTML = '';
            
            (dadosDetalhados[categoria] || []).forEach(aluno => {
                lista.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 py-2">
                        <div>
                            <div class="fw-bold text-dark">${aluno.nome}</div>
                            <small class="text-muted">${aluno.turma}</small>
                        </div>
                        <span class="badge bg-light text-dark border">${aluno.nota}%</span>
                    </li>`;
            });
            
            if (!lista.innerHTML) lista.innerHTML = '<li class="text-muted text-center py-3">Vazio.</li>';
            modal.show();
        };

        // --- Gr√°ficos ---
        
        // Pizza
        const ctxPizza = document.getElementById('chartPizza');
        if (ctxPizza) {
            pizzaChart = new Chart(ctxPizza, {
                type: 'doughnut',
                data: {
                    labels: ['Adequado', 'Intermedi√°rio', 'Cr√≠tico', 'M. Cr√≠tico'],
                    datasets: [{
                        data: {{ dados_pizza|default:"[]"|safe }},
                        backgroundColor: ['#198754', '#ffc107', '#dc3545', '#212529'],
                        borderWidth: 0
                    }]
                },
                options: {
                    ...chartOptions, cutout: '70%',
                    onClick: (evt, el) => { if(el.length > 0) abrirModalAlunos(['Adequado', 'Intermedi√°rio', 'Cr√≠tico', 'Muito Cr√≠tico'][el[0].index]); }
                }
            });
        }

        // Gr√°fico de Profici√™ncia
        const ctxProf = document.getElementById('chartProficiencia');
        if (ctxProf) {
            proficienciaChart = new Chart(ctxProf, {
                type: 'bar',
                data: {
                    labels: {{ labels_proficiencia|default:"[]"|safe }},
                    datasets: [{
                        label: 'Acerto (%)',
                        data: {{ dados_proficiencia|default:"[]"|safe }},
                        backgroundColor: function(context) {
                            const val = context.raw;
                            if (val >= 80) return '#198754'; // Verde (Adequado)
                            if (val >= 60) return '#ffc107'; // Amarelo (Intermedi√°rio)
                            if (val >= 21) return '#dc3545'; // Vermelho (Cr√≠tico)
                            return '#212529'; // Preto (Muito Cr√≠tico)
                        },
                        borderRadius: 6
                    }]
                },
                options: { 
                    ...chartOptions, 
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Evolu√ß√£o
        const ctxEvo = document.getElementById('chartEvolucao');
        if (ctxEvo) {
            evolucaoChart = new Chart(ctxEvo, {
                type: 'line',
                data: {
                    labels: {{ labels_evolucao|default:"[]"|safe }},
                    datasets: [{
                        label: 'M√©dia da Turma (%)',
                        data: {{ dados_evolucao|default:"[]"|safe }},
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { ...chartOptions, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        // Corre√ß√£o de Redimensionamento ao Trocar de Aba
        document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', () => {
                if(pizzaChart) pizzaChart.resize();
                if(proficienciaChart) proficienciaChart.resize();
                if(evolucaoChart) evolucaoChart.resize();
            });
        });
    });
</script>

<style>
    .hover-danger:hover { background-color: #dc3545; color: white !important; border-color: #dc3545 !important; }
</style>

{% endblock %}