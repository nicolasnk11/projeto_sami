{% extends 'core/base.html' %}

{% block content %}
<div class="container-fluid py-4">
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
                <i class="bi bi-info-circle-fill me-2"></i> {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark mb-0"><i class="bi bi-people-fill me-2"></i>Gerenciar Alunos</h3>
            <p class="text-muted small mb-0">Total listado: {{ matriculas.paginator.count }} alunos</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'importar_alunos' %}" class="btn btn-outline-success shadow-sm transition-hover">
                <i class="bi bi-file-earmark-spreadsheet me-2"></i> Importar Excel
            </a>
            <button class="btn btn-primary shadow-sm transition-hover" data-bs-toggle="modal" data-bs-target="#modalCriar">
                <i class="bi bi-plus-lg me-2"></i> Novo Aluno
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3 bg-light rounded">
            <form method="get" class="row g-3 align-items-center">
                
                <div class="col-md-2">
                    <select name="ano" class="form-select fw-bold text-primary border-primary" onchange="this.form.submit()">
                        <option value="2026" {% if ano_atual == '2026' %}selected{% endif %}>2026 (Atual)</option>
                        <option value="2025" {% if ano_atual == '2025' %}selected{% endif %}>2025 (Arquivo)</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" name="busca" class="form-control border-start-0" placeholder="Buscar por nome..." value="{{ busca_atual|default:'' }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <select name="turma" class="form-select" onchange="this.form.submit()">
                        <option value="">Todas as Turmas</option>
                        {% for t in turmas %}
                            <option value="{{ t.id }}" {% if turma_selecionada == t.id|stringformat:"s" %}selected{% endif %}>{{ t.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-auto">
                    <div class="form-check form-switch mt-1">
                        <input class="form-check-input" type="checkbox" name="apenas_pcd" value="on" id="filterPcd" onchange="this.form.submit()" {% if request.GET.apenas_pcd %}checked{% endif %}>
                        <label class="form-check-label fw-bold text-primary" for="filterPcd">
                            <i class="bi bi-universal-access-circle me-1"></i> Inclusão/PcD
                        </label>
                    </div>
                </div>
                <div class="col-md-auto ms-auto">
                    <button type="submit" class="btn btn-secondary">Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-lg overflow-hidden">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="ps-4 py-3">Nome Completo</th>
                            <th>Turma</th>
                            <th class="text-center">Status</th>
                            <th class="text-end pe-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mat in matriculas %}
                        <tr>
                            <td class="ps-4 fw-bold text-dark">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-3 shadow-sm" style="width: 40px; height: 40px; font-weight: bold;">
                                        {{ mat.aluno.nome_completo|slice:":1" }}
                                    </div>
                                    <div>
                                        <div class="d-flex align-items-center gap-2">
                                            {{ mat.aluno.nome_completo }}
                                            {% if mat.aluno.is_pcd %}
                                                <span class="badge bg-info text-white rounded-pill" title="Aluno de Inclusão / AEE">
                                                    <i class="bi bi-universal-access-circle"></i>
                                                </span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">Matrícula: #{{ mat.id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-white border text-dark">{{ mat.turma.nome }}</span>
                                {% if mat.turma.ano_letivo != 2026 %}
                                    <small class="text-muted ms-1">({{ mat.turma.ano_letivo }})</small>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if mat.status == 'CURSANDO' %}
                                    <span class="badge bg-success-subtle text-success">Cursando</span>
                                {% elif mat.status == 'APROVADO' %}
                                    <span class="badge bg-success">Aprovado</span>
                                {% elif mat.status == 'REPROVADO' %}
                                    <span class="badge bg-danger">Reprovado</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ mat.status }}</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-primary me-1" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalEditar"
                                        onclick="preencherEdicao('{{ mat.id }}', '{{ mat.aluno.nome_completo }}', '{{ mat.turma.id }}', '{{ mat.status }}', 
                                                                 '{{ mat.aluno.is_pcd|yesno:'true,false' }}', '{{ mat.aluno.tipo_deficiencia|default:'' }}', 
                                                                 '{{ mat.aluno.cor_raca|default:'NAO_DECLARADO' }}', '{{ mat.aluno.genero|default:'M' }}', 
                                                                 '{{ mat.aluno.renda_familiar|default:'' }}')">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalExcluir"
                                        onclick="preencherExclusao('{{ mat.id }}', '{{ mat.aluno.nome_completo }}')">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center py-5 text-muted">Nenhum aluno encontrado para o ano {{ ano_atual }}.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        {% if matriculas.has_other_pages %}
        <div class="card-footer bg-white py-3 border-top-0">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    {% if matriculas.has_previous %}
                        <li class="page-item"><a class="page-link border-0 text-secondary" href="?page={{ matriculas.previous_page_number }}&busca={{ busca_atual }}&ano={{ ano_atual }}">&laquo; Anterior</a></li>
                    {% endif %}
                    <li class="page-item disabled"><span class="page-link border-0 text-dark fw-bold">Pág {{ matriculas.number }}</span></li>
                    {% if matriculas.has_next %}
                        <li class="page-item"><a class="page-link border-0 text-primary fw-bold" href="?page={{ matriculas.next_page_number }}&busca={{ busca_atual }}&ano={{ ano_atual }}">Próxima &raquo;</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="modalCriar" tabindex="-1">
    <div class="modal-dialog">
        <form method="post" class="modal-content border-0 shadow">
            {% csrf_token %}
            <input type="hidden" name="acao" value="criar">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-person-plus-fill me-2"></i>Novo Aluno ({{ ano_atual }})</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">NOME DO ALUNO</label>
                    <input type="text" name="nome" class="form-control form-control-lg" placeholder="Nome Completo" required>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">TURMA</label>
                    <select name="turma" class="form-select" required>
                        <option value="">Selecione...</option>
                        {% for t in turmas %}
                            <option value="{{ t.id }}">{{ t.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <hr>
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label small fw-bold text-muted">COR / RAÇA</label>
                        <select name="cor_raca" class="form-select form-select-sm">
                            <option value="NAO_DECLARADO">Não Declarado</option>
                            <option value="BRANCA">Branca</option>
                            <option value="PRETA">Preta</option>
                            <option value="PARDA">Parda</option>
                            <option value="AMARELA">Amarela</option>
                            <option value="INDIGENA">Indígena</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <div class="form-check form-switch mt-4 bg-light p-2 rounded">
                            <input class="form-check-input" type="checkbox" name="is_pcd" id="checkNovoPcd">
                            <label class="form-check-label fw-bold text-dark ms-1 small" for="checkNovoPcd">Aluno Inclusão?</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary fw-bold px-4">Salvar Aluno</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form method="post" class="modal-content border-0 shadow">
            {% csrf_token %}
            <input type="hidden" name="acao" value="editar">
            <input type="hidden" name="matricula_id" id="edit_id"> 
            
            <div class="modal-header bg-white">
                <h5 class="modal-title fw-bold">Editar Aluno</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4 bg-light">
                <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active fw-bold small" id="pills-basic-tab" data-bs-toggle="pill" data-bs-target="#pills-basic" type="button">Dados Básicos</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link fw-bold small" id="pills-social-tab" data-bs-toggle="pill" data-bs-target="#pills-social" type="button">Perfil Social</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link fw-bold small text-info" id="pills-inclusao-tab" data-bs-toggle="pill" data-bs-target="#pills-inclusao" type="button">
                            <i class="bi bi-universal-access-circle me-1"></i> Inclusão/AEE
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="pills-tabContent">
                    <div class="tab-pane fade show active" id="pills-basic">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label small fw-bold text-muted">NOME COMPLETO</label>
                                <input type="text" name="nome" id="edit_nome" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">TURMA ATUAL</label>
                                <select name="turma" id="edit_turma" class="form-select" required>
                                    {% for t in turmas %}
                                        <option value="{{ t.id }}">{{ t.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">STATUS</label>
                                <select name="status" id="edit_status" class="form-select">
                                    <option value="CURSANDO">Cursando</option>
                                    <option value="APROVADO">Aprovado</option>
                                    <option value="REPROVADO">Reprovado</option>
                                    <option value="TRANSFERIDO">Transferido</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pills-social">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">COR / RAÇA</label>
                                <select name="cor_raca" id="edit_cor_raca" class="form-select">
                                    <option value="NAO_DECLARADO">Não Declarado</option>
                                    <option value="BRANCA">Branca</option>
                                    <option value="PRETA">Preta</option>
                                    <option value="PARDA">Parda</option>
                                    <option value="AMARELA">Amarela</option>
                                    <option value="INDIGENA">Indígena</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">GÊNERO</label>
                                <select name="genero" id="edit_genero" class="form-select">
                                    <option value="M">Masculino</option>
                                    <option value="F">Feminino</option>
                                    <option value="NB">Não-Binário</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label small fw-bold text-muted">RENDA FAMILIAR</label>
                                <select name="renda_familiar" id="edit_renda" class="form-select">
                                    <option value="">-- Selecione --</option>
                                    <option value="BAIXA">Até 1 Salário (Baixa Renda)</option>
                                    <option value="MEDIA_BAIXA">1 a 3 Salários</option>
                                    <option value="MEDIA">3 a 6 Salários</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pills-inclusao">
                        <div class="alert alert-info border-0 d-flex align-items-center mb-3">
                            <i class="bi bi-info-circle-fill me-3 fs-4"></i>
                            <div class="small lh-sm">
                                Marque esta opção para alunos com deficiência (PcD), TEA ou Altas Habilidades que necessitam de atendimento especializado.
                            </div>
                        </div>
                        
                        <div class="form-check form-switch mb-3 p-3 bg-white rounded border">
                            <input class="form-check-input" type="checkbox" name="is_pcd" id="edit_is_pcd">
                            <label class="form-check-label fw-bold text-dark ms-2" for="edit_is_pcd">
                                Ativar Perfil de Inclusão (Símbolo ♿)
                            </label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">TIPO DE CONDIÇÃO</label>
                            <select name="tipo_deficiencia" id="edit_tipo_deficiencia" class="form-select">
                                <option value="">-- Selecione --</option>
                                <option value="TEA">Autismo (TEA)</option>
                                <option value="TDAH">TDAH</option>
                                <option value="DI">Deficiência Intelectual</option>
                                <option value="DV">Deficiência Visual</option>
                                <option value="DA">Deficiência Auditiva</option>
                                <option value="DF">Deficiência Física</option>
                                <option value="AH">Altas Habilidades</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer bg-light border-0">
                <button type="submit" class="btn btn-primary px-4 rounded-pill">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalExcluir" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="acao" value="excluir">
                <input type="hidden" name="matricula_id" id="delete_id">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3"><i class="bi bi-exclamation-octagon text-danger" style="font-size: 3rem;"></i></div>
                    <p class="mb-1 fs-5">Tem certeza que deseja apagar?</p>
                    <h5 id="delete_nome" class="fw-bold text-dark my-3 bg-light p-2 rounded border">Nome do Aluno</h5>
                    <p class="text-danger small mb-0 fw-bold">Todas as notas deste aluno serão perdidas!</p>
                </div>
                <div class="modal-footer bg-light justify-content-center">
                    <button type="button" class="btn btn-light border fw-bold px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger fw-bold px-4">Sim, excluir</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Função atualizada para preencher TODOS os campos no modal de edição
    function preencherEdicao(id, nome, turmaId, status, isPcd, tipoDef, corRaca, genero, renda) {
        // Dados Básicos
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_nome').value = nome;
        document.getElementById('edit_turma').value = turmaId;
        document.getElementById('edit_status').value = status;
        
        // Dados Sociais
        document.getElementById('edit_cor_raca').value = corRaca || 'NAO_DECLARADO';
        document.getElementById('edit_genero').value = genero || 'M';
        document.getElementById('edit_renda').value = renda || '';

        // Dados de Inclusão
        document.getElementById('edit_is_pcd').checked = (isPcd === 'true');
        document.getElementById('edit_tipo_deficiencia').value = tipoDef || '';
    }

    function preencherExclusao(id, nome) {
        document.getElementById('delete_id').value = id;
        document.getElementById('delete_nome').innerText = nome;
    }
</script>

<style>
    .transition-hover:hover { transform: translateY(-2px); transition: transform 0.2s; }
</style>

{% endblock %}