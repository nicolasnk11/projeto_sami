{% extends 'core/base.html' %}

{% block content %}
<div class="container py-5">
    
    <div class="text-center mb-5">
        <h2 class="fw-bold text-dark">üèÅ Virada de Ano Letivo (2025 &rarr; 2026)</h2>
        <p class="text-muted">Confira as notas, ajuste o resultado final e promova os alunos com seguran√ßa.</p>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm mt-3 w-75 mx-auto" role="alert">
                    <i class="bi bi-info-circle-fill me-2"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4">
            <form method="get" class="row align-items-center justify-content-center">
                <div class="col-auto">
                    <label class="fw-bold text-uppercase small text-muted">Selecione a S√©rie de 2025:</label>
                </div>
                <div class="col-md-4">
                    <select name="serie_filtro" class="form-select form-select-lg fw-bold text-center border-primary" onchange="this.form.submit()">
                        <option value="">-- Escolha --</option>
                        <option value="1" {% if serie_filtro == '1' %}selected{% endif %}>1¬∫ Ano (Ir√£o para o 2¬∫)</option>
                        <option value="2" {% if serie_filtro == '2' %}selected{% endif %}>2¬∫ Ano (Ir√£o para o 3¬∫)</option>
                        <option value="3" {% if serie_filtro == '3' %}selected{% endif %}>3¬∫ Ano (Formandos)</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    {% if alunos %}
    <form method="post">
        {% csrf_token %}
        <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
            <div class="card-header bg-primary text-white py-3 px-4 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="bi bi-list-check me-2"></i>Confer√™ncia Final</h5>
                <span class="badge bg-white text-primary rounded-pill">{{ alunos|length }} Alunos Listados</span>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-uppercase small fw-bold">
                        <tr>
                            <th class="ps-4">Aluno</th>
                            <th>Turma 2025</th>
                            <th class="text-center">M√©dia Calc.</th>
                            <th class="text-center" style="width: 220px;">Decis√£o Final</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in alunos %}
                        <tr>
                            <td class="ps-4 fw-bold text-dark">
                                {{ a.nome }}
                                <input type="hidden" name="matricula_id" value="{{ a.id }}">
                                <input type="hidden" name="nota_{{ a.id }}" value="{{ a.media }}">
                            </td>
                            <td><span class="badge bg-light text-muted border">{{ a.turma }}</span></td>
                            
                            <td class="text-center">
                                <span class="badge rounded-pill {% if a.media >= 6 %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                    {{ a.media }}
                                </span>
                            </td>
                            
                            <td class="text-center">
                                <select name="status_{{ a.id }}" class="form-select form-select-sm fw-bold"
                                        style="font-size: 0.85rem;" 
                                        onchange="atualizarCorSelect(this)">
                                    
                                    <option value="APROVADO" class="text-success fw-bold" {% if a.status_sugerido == 'APROVADO' %}selected{% endif %}>
                                        ‚úÖ APROVADO
                                    </option>
                                    
                                    <option value="REPROVADO" class="text-danger fw-bold" {% if a.status_sugerido == 'REPROVADO' %}selected{% endif %}>
                                        üî¥ REPROVADO
                                    </option>
                                    
                                    <option value="TRANSFERIDO" class="text-warning fw-bold">
                                        ‚úàÔ∏è TRANSFERIDO (Saiu)
                                    </option>
                                    
                                    <option value="ABANDONO" class="text-secondary fw-bold">
                                        ‚ùå ABANDONO (Desistiu)
                                    </option>
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card-footer bg-light p-4 text-end">
                <div class="d-flex justify-content-end align-items-center gap-3">
                    <small class="text-muted">Ao confirmar, alunos marcados como "Transferido" ou "Abandono" <strong>n√£o</strong> ser√£o matriculados em 2026.</small>
                    <button type="submit" class="btn btn-success btn-lg fw-bold rounded-pill px-5 shadow transition-hover" onclick="return confirm('ATEN√á√ÉO: Isso ir√° processar o hist√≥rico de 2025 e gerar as turmas de 2026. Deseja continuar?')">
                        <i class="bi bi-rocket-takeoff-fill me-2"></i> CONFIRMAR E MIGRAR
                    </button>
                </div>
            </div>
        </div>
    </form>
    {% elif serie_filtro %}
        <div class="alert alert-warning text-center shadow-sm">
            <i class="bi bi-exclamation-circle me-2"></i> Nenhum aluno "CURSANDO" encontrado nesta s√©rie em 2025. Talvez j√° tenham sido migrados?
        </div>
    {% endif %}

</div>

<script>
    function atualizarCorSelect(select) {
        select.className = 'form-select form-select-sm fw-bold'; // Reseta
        if (select.value === 'APROVADO') select.classList.add('text-success', 'border-success');
        else if (select.value === 'REPROVADO') select.classList.add('text-danger', 'border-danger');
        else if (select.value === 'TRANSFERIDO') select.classList.add('text-warning', 'border-warning');
        else if (select.value === 'ABANDONO') select.classList.add('text-secondary', 'border-secondary');
    }

    // Inicializa as cores ao carregar a p√°gina
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('select[name^="status_"]').forEach(sel => atualizarCorSelect(sel));
    });
</script>

<style>
    .transition-hover:hover { transform: translateY(-3px); transition: transform 0.2s; }
</style>
{% endblock %}